name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create host logs dir
        run: mkdir -p logs

      # Build image from Dockerfile at repo root
      - name: Build Docker image
        run: |
          docker build \
            -t darshan-mpi:ci \
            --build-arg DARSHAN_TAG=darshan-3.4.3 \
            .

      # Run example, enable Darshan via mpirun -x, ensure date subfolders exist
      - name: Run MPI example to generate Darshan logs
        run: |
          docker run --rm \
            -e DOCKER_JOBID=ci-job \
            -v "$PWD/logs":/tmp \
            darshan-mpi:ci \
            bash -lc '
              set -e
              # répertoire daté attendu par Darshan: /tmp/YYYY/M/D
              DIR=/tmp/$(date +%Y/%-m/%-d); mkdir -p "$DIR"; echo "[debug] created $DIR"
              echo "[debug] darshan libs in /usr/local/lib:"; ls -1 /usr/local/lib/libdarshan* || true
              # exécuter (oversubscribe pour runner CI; export explicite des variables aux rangs MPI)
              mpirun --allow-run-as-root --oversubscribe -np ${NP:-2} \
                -x LD_PRELOAD=/usr/local/lib/libdarshan.so:/usr/local/lib/libdarshan-mpi-io.so:/usr/local/lib/libdarshan-posix.so \
                -x DARSHAN_LOGPATH=/tmp \
                -x DOCKER_JOBID=ci-job \
                ./my_mpi_io
              echo "[debug] darshan files under /tmp:"
              find /tmp -type f -name "*.darshan*" -print || true
            '

      # Parse: find log recursively and pass path relative to /tmp into container
      - name: Parse Darshan logs (sanity check)
        run: |
          set -e
          echo "Tree under logs/:"
          ls -R logs || true
          LOG_FILE=$(find logs -type f \( -name "*.darshan" -o -name "*.darshan.gz" \) | head -n1)
          if [ -z "$LOG_FILE" ]; then
            echo "No darshan log found!" && exit 1
          fi
          echo "Found log: $LOG_FILE"
          REL="${LOG_FILE#logs/}"
          docker run --rm -v "$PWD/logs":/tmp darshan-mpi:ci \
            bash -lc "darshan-parser \"/tmp/${REL}\" | head -n 80"

      # Generate HTML summary (gnuplot + TeX deps already in the image)
      - name: Generate job summary (HTML)
        run: |
          LOG_FILE=$(find logs -type f \( -name "*.darshan" -o -name "*.darshan.gz" \) | head -n1)
          REL="${LOG_FILE#logs/}"
          docker run --rm -v "$PWD/logs":/tmp darshan-mpi:ci \
            bash -lc "darshan-job-summary.pl \"/tmp/${REL}\""

      # Upload artifacts (logs + summary + plots)
      - name: Upload artifacts (Darshan logs & summary)
        uses: actions/upload-artifact@v4
        with:
          name: darshan-logs-and-summary
          path: |
            logs/**/*.darshan*
            logs/**/*_summary.html
            logs/**/*.png
          if-no-files-found: warn
