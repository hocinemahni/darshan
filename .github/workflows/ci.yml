name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create host logs dir
        run: mkdir -p logs

      - name: Build Docker image
        run: |
          docker build \
            -t darshan-mpi:ci \
            --build-arg DARSHAN_TAG=darshan-3.4.3 \
            .

      - name: Run MPI example to generate Darshan logs
        run: |
          docker run --rm \
            -e DOCKER_JOBID=ci-job \
            -v "$PWD/logs":/tmp \
            darshan-mpi:ci \
            bash -lc '
              set -e

              DIR=/tmp/$(date +%Y/%-m/%-d)
              mkdir -p "$DIR"

              echo "[debug] libs:"
              ls -l /usr/local/lib/libdarshan*

              mpirun --allow-run-as-root --oversubscribe -np 2 \
                -x LD_PRELOAD="/usr/local/lib/libdarshan.so:/usr/local/lib/libdarshan-mpi-io.so:/usr/local/lib/libdarshan-posix.so" \
                -x DARSHAN_LOGPATH=/tmp \
                -x DOCKER_JOBID=ci-job \
                ./my_mpi_io

              echo "[debug] logs found:"
              find /tmp -type f -name "*.darshan*" -print
            '

      - name: Parse Darshan logs (sanity check)
        run: |
          LOG_FILE=$(find logs -type f | grep darshan | head -n1)
          if [ -z "$LOG_FILE" ]; then echo "No log found"; exit 1; fi
          REL="${LOG_FILE#logs/}"

          docker run --rm -v "$PWD/logs":/tmp darshan-mpi:ci \
            bash -lc "darshan-parser /tmp/${REL} | head -n 60"

      - name: Generate job summary (HTML)
        run: |
          LOG_FILE=$(find logs -type f | grep darshan | head -n1)
          REL="${LOG_FILE#logs/}"

          docker run --rm -v "$PWD/logs":/tmp darshan-mpi:ci \
            bash -lc "
              echo '[debug] Generating summary...'
              darshan-job-summary.pl /tmp/${REL}
              echo '[debug] Summary done' 
            "

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: darshan-output
          path: |
            logs/*.darshan*
            logs/*.pdf
            logs/*.html
            logs/*.png
          if-no-files-found: warn
