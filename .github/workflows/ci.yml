name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create logs dir (host)
        run: mkdir -p logs

      # Build l'image depuis le Dockerfile à la racine
      - name: Build Docker image
        run: |
          docker build \
            -t darshan-mpi:ci \
            --build-arg DARSHAN_TAG=darshan-3.4.3 \
            .

      # Exécute l'exemple MPI et génère des logs Darshan dans ./logs
      - name: Run MPI example to generate Darshan logs
        run: |
          docker run --rm \
            -e DOCKER_JOBID=ci-job \
            -e OMPI_ALLOW_RUN_AS_ROOT=1 \
            -e OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1 \
            -e LD_PRELOAD=/opt/darshan-install/lib/libdarshan.so \
            -e DARSHAN_LOGPATH=/tmp \
            -e DARSHAN_ENABLE_NONMPI=1 \
            -v "$PWD/logs":/tmp \
            darshan-mpi:ci \
            sh -lc 'mpirun --allow-run-as-root --oversubscribe -np 2 ./my_mpi_io && ls -l /tmp'

      # Parse du log (supporte .darshan et .darshan.gz)
      - name: Parse Darshan logs (sanity check)
        run: |
          set -e
          echo "Files in logs/:"
          ls -l logs || true
          LOG_FILE=$(find logs -maxdepth 1 -type f -name "*.darshan*" | head -n1)
          if [ -z "$LOG_FILE" ]; then
            echo "No darshan log found!" && exit 1
          fi
          echo "Parsing $LOG_FILE"
          docker run --rm -v "$PWD/logs":/tmp darshan-mpi:ci \
            sh -lc "darshan-parser /tmp/$(basename "$LOG_FILE") | head -n 50"

      # Génère le résumé HTML (installe gnuplot à la volée)
      - name: Generate job summary (HTML)
        run: |
          LOG_FILE=$(find logs -maxdepth 1 -type f -name "*.darshan*" | head -n1)
          docker run --rm \
            -v "$PWD/logs":/tmp \
            darshan-mpi:ci \
            sh -lc "apt-get update && apt-get install -y gnuplot && darshan-job-summary.pl /tmp/$(basename "$LOG_FILE")"

      # Artefacts (logs + summary + images)
      - name: Upload artifacts (Darshan logs & summary)
        uses: actions/upload-artifact@v4
        with:
          name: darshan-logs-and-summary
          path: |
            logs/*.darshan*
            logs/*_summary.html
            logs/*.png
          if-no-files-found: warn
