name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create host logs dir
        run: mkdir -p logs

      # Build image from Dockerfile at repo root
      - name: Build Docker image
        run: |
          docker build \
            -t darshan-mpi:ci \
            --build-arg DARSHAN_TAG=darshan-3.4.3 \
            .

      # Run example, enable Darshan, and ensure date subfolders exist under /tmp
      - name: Run MPI example to generate Darshan logs
        run: |
          docker run --rm \
            -e DOCKER_JOBID=ci-job \
            -e OMPI_ALLOW_RUN_AS_ROOT=1 \
            -e OMPI_ALLOW_RUN_AS_ROOT_CONFIRM=1 \
            -e LD_PRELOAD="/usr/local/lib/libdarshan.so:/usr/local/lib/libdarshan-mpi-io.so:/usr/local/lib/libdarshan-posix.so" \
            -e DARSHAN_LOGPATH=/tmp \
            -v "$PWD/logs":/tmp \
            darshan-mpi:ci \
            sh -lc '
              set -e
              echo "[debug] darshan libs in image:" && ls -l /usr/local/lib | grep darshan || true
              # create Darshan date-based directory (/tmp/YYYY/M/D)
              DIR=/tmp/$(date +%Y/%-m/%-d) && mkdir -p "$DIR" && echo "[debug] created $DIR"
              # run MPI (oversubscribe to avoid slot issues on CI)
              mpirun --allow-run-as-root --oversubscribe -np 2 ./my_mpi_io
              echo "[debug] /tmp content:" && ls -R /tmp || true
            '

      # Parse a produced log (accept .darshan and .darshan.gz; search in subfolders)
      - name: Parse Darshan logs (sanity check)
        run: |
          set -e
          echo "Files in logs/:"
          ls -R logs || true
          LOG_FILE=$(find logs -type f \( -name "*.darshan" -o -name "*.darshan.gz" \) | head -n1)
          if [ -z "$LOG_FILE" ]; then
            echo "No darshan log found!" && exit 1
          fi
          echo "Parsing $LOG_FILE"
          docker run --rm -v "$PWD/logs":/tmp darshan-mpi:ci \
            sh -lc "darshan-parser /tmp/$(basename "$LOG_FILE") | head -n 50"

      # Generate HTML summary next to the log (installs gnuplot inside the container)
      - name: Generate job summary (HTML)
        run: |
          LOG_FILE=$(find logs -type f \( -name "*.darshan" -o -name "*.darshan.gz" \) | head -n1)
          docker run --rm \
            -v "$PWD/logs":/tmp \
            darshan-mpi:ci \
            sh -lc "apt-get update && apt-get install -y gnuplot && darshan-job-summary.pl /tmp/$(basename "$LOG_FILE")"

      # Upload artifacts (logs + summary + plots)
      - name: Upload artifacts (Darshan logs & summary)
        uses: actions/upload-artifact@v4
        with:
          name: darshan-logs-and-summary
          path: |
            logs/**/*.darshan*
            logs/*_summary.html
            logs/*.png
          if-no-files-found: warn
